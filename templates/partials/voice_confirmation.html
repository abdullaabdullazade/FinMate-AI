<!-- Voice Confirmation Modal - User can review and edit transcribed text before saving -->
<div class="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in"
    id="voice-confirmation">
    <div class="glass-card w-full max-w-sm max-h-[85vh] overflow-y-auto relative slide-up flex flex-col">

        <!-- Header -->
        <div class="p-4 pb-0 text-center">
            <div
                class="w-14 h-14 bg-purple-500/20 rounded-full flex items-center justify-center mx-auto mb-3 border border-purple-500/30">
                <span class="text-2xl">üé§</span>
            </div>
            <h3 class="text-xl font-bold text-white mb-1">S…ôsi yoxlayƒ±n</h3>
            <p class="text-white/60 text-xs">D√ºz ba≈üa d√º≈üd√ºms…ô, davam edin</p>
        </div>

        <!-- Form for editing -->
        <form hx-post="/api/confirm-voice" hx-swap="beforeend" hx-target="body">
            <input type="hidden" name="category" value="{{ expense_data.category }}">

            <div class="p-4 space-y-4">
                <!-- Transcribed Text Display -->
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <p class="text-xs text-white/50 mb-2">Siz dediniz:</p>
                    <p class="text-white italic text-sm">"{{ transcribed_text }}"</p>
                </div>

                <!-- Editable Amount -->
                <div class="text-center bg-white/5 rounded-xl p-4 border border-white/10">
                    <p class="text-white/60 text-sm mb-2">M…ôbl…ôƒü</p>
                    <div class="flex items-center justify-center gap-2">
                        <input type="number" name="amount" step="0.01" value="{{ expense_data.amount }}"
                            class="text-4xl font-bold text-white bg-transparent border-b-2 border-purple-500/50 focus:border-purple-500 outline-none text-center w-40"
                            required>
                        <span class="text-xl text-white/60">AZN</span>
                    </div>
                    <p class="text-xs text-white/40 mt-2">Yanlƒ±≈üdƒ±rsa d√ºz…ôldin</p>
                </div>

                <!-- Editable Merchant/Item Name -->
                <div class="bg-white/5 rounded-xl p-4 border border-white/10">
                    <label class="block text-xs text-white/50 mb-2">M…ôhsul / Xidm…ôt</label>
                    <input type="text" name="merchant" value="{{ expense_data.merchant }}"
                        class="w-full text-white bg-transparent border-b border-white/20 focus:border-purple-500 outline-none py-2"
                        required>
                </div>

                <!-- Category Display -->
                <div class="bg-white/5 rounded-xl p-3 border border-white/10">
                    <p class="text-xs text-white/50 mb-1">Kateqoriya</p>
                    <span class="inline-block px-2 py-0.5 bg-purple-500/30 text-purple-200 rounded text-xs font-medium">
                        {{ expense_data.category }}
                    </span>
                </div>
            </div>

            <!-- Actions -->
            <div class="p-4 pt-0 mt-auto space-y-2">
                <button type="button" onclick="
                    const form = this.closest('form');
                    const formData = new FormData(form);
                    
                    fetch('/api/confirm-voice', {
                        method: 'POST',
                        body: formData
                    }).then(response => response.text())
                    .then(html => {
                        document.getElementById('voice-confirmation').remove();
                        // Insert HTML
                        document.body.insertAdjacentHTML('beforeend', html);
                        // Extract and execute scripts manually (scripts don't auto-execute in insertAdjacentHTML)
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const scripts = tempDiv.querySelectorAll('script');
                        scripts.forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => {
                                newScript.setAttribute(attr.name, attr.value);
                            });
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            document.body.appendChild(newScript);
                        });
                    }).catch(error => {
                        console.error('Error:', error);
                        alert('X…ôta ba≈ü verdi');
                    });
                "
                    class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white font-bold py-3 rounded-xl hover:scale-[1.02] active:scale-95 transition shadow-lg shadow-purple-500/25">
                    ‚úÖ D√ºzd√ºr, saxla
                </button>
                <button type="button"
                    onclick="this.closest('.fixed').remove(); document.getElementById('voice-modal').classList.remove('hidden');"
                    class="w-full bg-white/10 hover:bg-white/20 text-white py-2.5 rounded-xl font-medium transition">
                    ‚Üê Yenid…ôn c…ôhd et
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .slide-up {
        animation: slideUp 0.4s ease-out forwards;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Remove spinner arrows from number input */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        appearance: none;
        margin: 0;
    }

    input[type=number] {
        -moz-appearance: textfield;
        appearance: textfield;
    }
</style>

<script>
    // Trigger audio when voice confirmation modal opens
    (function() {
        'use strict';
        
        function triggerVoiceConfirmationAudio() {
            const modal = document.getElementById('voice-confirmation');
            if (!modal) return;
            
            // Check if voice mode is enabled
            const voiceMode = localStorage.getItem('voice-mode');
            if (voiceMode !== 'enabled') return;
            
            // Skip if voice modal is open (recording interface)
            const voiceModal = document.getElementById('voice-modal');
            if (voiceModal && !voiceModal.classList.contains('hidden')) {
                console.log('üîá Skipping voice confirmation audio - voice modal is open');
                return;
            }
            
            // Build audio message
            let audioMessage = 'S…ôsi yoxlayƒ±n. D√ºz ba≈üa d√º≈üd√ºms…ô, davam edin.';
            
            // Get transcribed text
            const transcribedText = modal.querySelector('p.text-white.italic');
            if (transcribedText) {
                const text = transcribedText.textContent.trim().replace(/[""]/g, '');
                if (text) {
                    audioMessage += ` Siz dediniz: ${text}.`;
                }
            }
            
            // Get amount
            const amountInput = modal.querySelector('input[name="amount"]');
            if (amountInput) {
                const amount = parseFloat(amountInput.value) || 0;
                if (amount > 0) {
                    if (typeof window.numberToAzerbaijani === 'function') {
                        const amountText = window.numberToAzerbaijani(amount);
                        audioMessage += ` M…ôbl…ôƒü: ${amountText}.`;
                    } else {
                        audioMessage += ` M…ôbl…ôƒü: ${amount} manat.`;
                    }
                }
            }
            
            // Get merchant
            const merchantInput = modal.querySelector('input[name="merchant"]');
            if (merchantInput && merchantInput.value) {
                audioMessage += ` M…ôhsul: ${merchantInput.value}.`;
            }
            
            // Get category
            const categorySpan = modal.querySelector('span.bg-purple-500\\/30');
            if (categorySpan) {
                audioMessage += ` Kateqoriya: ${categorySpan.textContent.trim()}.`;
            }
            
            // Get button instructions
            const buttons = modal.querySelectorAll('button');
            const buttonTexts = [];
            buttons.forEach(btn => {
                const btnText = btn.textContent.trim();
                if (btnText && btnText.length < 50) {
                    const cleanText = btnText.replace(/[‚úì‚úÖ‚Üêüé§]/g, '').trim();
                    if (cleanText) {
                        buttonTexts.push(cleanText);
                    }
                }
            });
            
            if (buttonTexts.length >= 2) {
                const confirmBtn = buttonTexts.find(t => t.includes('D√ºzd√ºr') || t.includes('Saxla') || t.includes('T…ôsdiq'));
                const cancelBtn = buttonTexts.find(t => t.includes('Yenid…ôn') || t.includes('C…ôhd') || t.includes('L…ôƒüv'));
                
                if (confirmBtn && cancelBtn) {
                    audioMessage += ` ∆èg…ôr d√ºz ba≈üa d√º≈üd√ºms…ô, ${confirmBtn} d√ºym…ôsin…ô basƒ±n. ∆èg…ôr yenid…ôn c…ôhd etm…ôk ist…ôyirsinizs…ô, ${cancelBtn} d√ºym…ôsin…ô basƒ±n.`;
                } else {
                    audioMessage += ` D√ºym…ôl…ôr: ${buttonTexts[0]}, ${buttonTexts[1]}.`;
                }
            }
            
            // Clean and send audio message
            const cleanMessage = audioMessage
                .replace(/\s+/g, ' ') // Normalize whitespace
                .trim();
            
            if (cleanMessage && typeof window.queueVoiceNotification === 'function') {
                console.log('üîä Voice confirmation audio:', cleanMessage);
                window.queueVoiceNotification(cleanMessage, 0, 'az'); // High priority
            }
        }
        
        // Wait for modal to be fully rendered and try multiple times
        let attempts = 0;
        const maxAttempts = 5;
        const checkInterval = setInterval(() => {
            attempts++;
            const modal = document.getElementById('voice-confirmation');
            if (modal) {
                clearInterval(checkInterval);
                // Wait a bit more for content to load
                setTimeout(() => {
                    triggerVoiceConfirmationAudio();
                }, 300);
            } else if (attempts >= maxAttempts) {
                clearInterval(checkInterval);
            }
        }, 200);
    })();
</script>