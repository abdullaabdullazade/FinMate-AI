{% if success %}
<!-- Result Inline Card -->
<div class="w-full animate-fade-in" hx-trigger="load" hx-get="/api/dashboard-updates" hx-target="#dashboard-stats"
    hx-swap="none" id="success-result">
    <script>
        console.log('üìã Receipt scan result modal loaded');

        // Trigger dashboard refresh
        document.body.dispatchEvent(new Event('newTransaction'));
        
        // Check for level up and show coin reward
        {% if xp_result and xp_result.level_up %}
        if (typeof triggerLevelUp === 'function') {
            setTimeout(() => {
                triggerLevelUp('{{ xp_result.new_level }}', {{ xp_result.level_info|tojson|safe }}, {{ xp_result.coins_awarded|default(0) }});
            }, 500);
        }
        {% endif %}
        
        // Reload page after receipt is confirmed (for scan page)
        // This will reload when user clicks "L√∂vh…ôy…ô qayƒ±t" or after confirmation
        // Store flag to reload on navigation
        if (window.location.pathname === '/scan' || window.location.pathname.includes('scan')) {
            // Mark that we should reload when navigating
            sessionStorage.setItem('reloadAfterReceipt', 'true');
        }

        // Voice notification - using queue system with HIGH priority
        (function () {
            const voiceMode = localStorage.getItem('voice-mode');
            if (voiceMode === 'enabled' && typeof window.queueVoiceNotification === 'function') {
                const total = parseFloat('{{ receipt_data.total }}') || 0;
                const itemCount = parseInt('{{ receipt_data.get("items", [])|length }}') || 0;

                console.log('üîä Receipt scan - queuing voice...');

                // Use numberToAzerbaijani for natural pronunciation
                let amountText = total.toFixed(2) + ' manat';
                if (typeof window.numberToAzerbaijani === 'function') {
                    amountText = window.numberToAzerbaijani(total);
                }

                const message = `Q…ôbz oxundu! ${itemCount} m…ôhsul tapƒ±ldƒ±. √úmumi ${amountText}`;

                // Queue with priority 0 (urgent)
                window.queueVoiceNotification(message, 0, 'az');
            }
        })();
    </script>
    <!-- Card Content -->
    <div class="glass-card w-full max-w-2xl mx-auto relative slide-up flex flex-col">

        <!-- Close Button -->
        <button onclick="resetScan();"
            class="absolute top-4 right-4 p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>

        <!-- Header -->
        <div class="p-6 pb-0 text-center">
            <div
                class="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-green-500/30">
                <span class="text-3xl">üßæ</span>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1">Q…ôbz oxundu</h3>
            <p class="text-white/60 text-sm">
                {% if receipt_data.date_time %}
                {{ receipt_data.date_time }}
                {% elif receipt_data.date %}
                {{ receipt_data.date }}{% if receipt_data.time %}, {{ receipt_data.time }}{% endif %}
                {% else %}
                {{ receipt_data.date }}
                {% endif %}
            </p>
        </div>

        <!-- XP Award Banner -->
        {% if xp_result %}
        <div
            class="mx-6 mt-6 p-4 bg-gradient-to-r from-yellow-400/20 to-orange-500/20 border border-yellow-400/30 rounded-xl flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">üèÜ</span>
                <div>
                    <p class="text-white font-bold text-sm">XP Awarded!</p>
                    <p class="text-white/70 text-xs">For scanning receipt</p>
                </div>
            </div>
            <span class="text-xl font-bold text-yellow-400">+{{ xp_result.xp_awarded }} XP</span>
        </div>
        {% endif %}

        <!-- Coin Award Banner -->
        <div
            class="mx-6 mt-4 p-4 bg-gradient-to-r from-amber-400/20 to-yellow-500/20 border border-amber-400/30 rounded-xl flex items-center justify-between">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ü™ô</span>
                <div>
                    <p class="text-white font-bold text-sm">FinMate Coin!</p>
                    <p class="text-white/70 text-xs">Toplam: {{ coins }} coin</p>
                </div>
            </div>
            <span class="text-xl font-bold text-yellow-400">+{{ xp_result.coins_awarded|default(1) }} ü™ô</span>
        </div>

        <!-- Milestone Celebration -->
        {% if milestone_reached %}
        <script>
            // Celebrate milestone
            setTimeout(() => {
                if (typeof window.queueVoiceNotification === 'function') {
                    const message = "{{ milestone_reached.name }} m√ºkafatƒ± qazandƒ±nƒ±z! {{ milestone_reached.reward }}";
                    window.queueVoiceNotification(message, 0, 'az');
                }
            }, 1500);
        </script>
        <div
            class="mx-6 mt-4 p-6 bg-gradient-to-br from-purple-500/30 to-pink-500/30 border-2 border-yellow-400 rounded-xl text-center animate-pulse">
            <div class="text-5xl mb-3">{{ milestone_reached.name.split(' ')[0] }}</div>
            <h4 class="text-2xl font-bold text-white mb-2">{{ milestone_reached.name.split(' ')[1] }} M√ºkafat!</h4>
            <p class="text-white/90 text-lg mb-3">{{ milestone_reached.reward }}</p>
            <div class="flex items-center justify-center gap-2 text-yellow-300 font-bold">
                <span class="text-xl">ü™ô</span>
                <span class="text-2xl">{{ milestone_reached.coins }} coins</span>
            </div>
        </div>
        {% endif %}

        <!-- Daily Limit Alert -->
        {% if daily_limit_alert %}
        <script>
            // Speak daily limitwarning
            if (typeof window.speakNotification === 'function') {
                setTimeout(() => {
                    window.speakNotification('{{ daily_limit_alert.message }}', 'warning');
                }, 1500);
            }
        </script>
        <div
            class="mx-6 mt-4 p-4 bg-gradient-to-r from-red-500/20 to-orange-500/20 border border-red-500/30 rounded-xl">
            <div class="flex items-start gap-3">
                <span class="text-2xl">üö®</span>
                <div class="flex-1">
                    <p class="text-white font-bold text-sm mb-1">G√ºnd…ôlik Limit Ke√ßildi!</p>
                    <p class="text-white/80 text-xs">{{ daily_limit_alert.message }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Details -->
        <div class="p-6 space-y-6">
            <!-- Total Amount -->
            <div class="text-center">
                <p class="text-white/60 text-sm mb-1">√úmumi m…ôbl…ôƒü</p>
                <p class="text-4xl font-bold text-white">{{ "%.2f"|format(receipt_data.total) }} <span
                        class="text-xl text-white/60">AZN</span></p>
                {% if conversion_note %}
                <p class="text-xs text-white/50 mt-1">
                    Orijinal: {{ "%.2f"|format(receipt_data.get('total_original', receipt_data.total)) }} {{
                    receipt_data.get('original_currency', receipt_data.currency or 'AZN') }}
                </p>
                <p class="text-xs text-green-300 mt-1">{{ conversion_note }}</p>
                {% endif %}
            </div>

            <!-- Merchant & Category -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white/5 rounded-xl p-3 border border-white/10">
                    <p class="text-xs text-white/50 mb-1">Satƒ±cƒ±</p>
                    <p class="text-white font-medium truncate">{{ receipt_data.merchant }}</p>
                </div>
                <div class="bg-white/5 rounded-xl p-3 border border-white/10">
                    <p class="text-xs text-white/50 mb-1">Kateqoriya</p>
                    <span
                        class="inline-block px-2 py-0.5 bg-purple-500/30 text-purple-200 rounded text-xs font-medium truncate max-w-full">
                        {{ receipt_data.suggested_category }}
                    </span>
                </div>
            </div>

            <!-- Items List -->
            {% if receipt_data.get('items') %}
            <div>
                <p class="text-sm text-white/70 mb-3 font-medium">M…ôhsullar</p>
                <div class="space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar">
                    {% for item in receipt_data.get('items', []) %}
                    <div
                        class="flex justify-between items-center bg-white/5 rounded-lg p-3 hover:bg-white/10 transition">
                        <span class="text-white/90 text-sm">{{ item.name }}</span>
                        <span class="text-white font-bold text-sm">{{ "%.2f"|format(item.price) }} AZN</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Actions -->
        <div class="p-6 pt-0 mt-auto">
            <button
                class="block w-full mb-3 bg-white/10 hover:bg-white/20 text-white text-center py-3.5 rounded-xl font-bold transition"
                data-total="{{ receipt_data.total }}" data-items='{{ receipt_data["items"]|tojson|safe }}'
                onclick="openSplitBill(this.dataset.total, JSON.parse(this.dataset.items || '[]'))">
                ü§ù Dostlarla b√∂l
            </button>
            <a href="/" onclick="if(window.location.pathname === '/scan' || window.location.pathname.includes('scan')) { window.location.href = '/'; return false; }"
                class="block w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-center py-3.5 rounded-xl font-bold hover:scale-[1.02] active:scale-95 transition shadow-lg shadow-indigo-500/25">
                L√∂vh…ôy…ô qayƒ±t
            </a>
            <button onclick="resetScan();"
                class="block w-full text-white/50 text-sm text-center mt-4 hover:text-white transition">
                Ba≈üqa q…ôbz skan et
            </button>
        </div>
    </div>
</div>

<style>
    .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 2px;
    }
</style>

{% else %}
<!-- Error Inline Card -->
<div class="w-full animate-fade-in" id="error-result">
    <div class="glass-card w-full max-w-2xl mx-auto p-6 relative slide-up bg-red-500/10 border-red-500/30">
        <button onclick="resetScan();" class="absolute top-4 right-4 text-white/70 hover:text-white">
            ‚úï
        </button>

        <div class="text-center">
            <div
                class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/30">
                {% if receipt_data.is_not_receipt %}
                <span class="text-3xl">üìÑ</span>
                {% else %}
                <span class="text-3xl">‚ùå</span>
                {% endif %}
            </div>
            {% if receipt_data.is_not_receipt %}
            <h3 class="text-xl font-bold text-white mb-2">Q…ôbz deyil</h3>
            <p class="text-white/70 mb-6">Bu ≈ü…ôkil q…ôbz kimi tanƒ±nmadƒ±. Xahi≈ü edirik q…ôbz ≈ü…ôkli y√ºkl…ôyin v…ô yenid…ôn c…ôhd
                edin.</p>
            {% else %}
            <h3 class="text-xl font-bold text-white mb-2">X…ôta ba≈ü verdi</h3>
            <p class="text-white/70 mb-6">{{ receipt_data.error if receipt_data.error else 'Q…ôbzi oxumaq alƒ±nmadƒ±,
                yenid…ôn c…ôhd edin.' }}</p>
            {% endif %}

            <button onclick="resetScan();"
                class="w-full bg-white/10 hover:bg-white/20 text-white py-3 rounded-xl font-medium transition">
                Yenid…ôn c…ôhd et
            </button>
        </div>
    </div>
</div>
{% endif %}