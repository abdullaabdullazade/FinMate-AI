{% extends "base.html" %}

{% block title %}X…ôrit…ô - FinMate AI{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #map {
        height: 70vh;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    .merchant-marker {
        background-color: #ef4444;
        border: 2px solid white;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
    }

    .merchant-label {
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .leaflet-popup-content-wrapper {
        background: rgba(30, 30, 46, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .leaflet-popup-content {
        color: white;
        margin: 12px;
    }

    .leaflet-popup-tip {
        background: rgba(30, 30, 46, 0.95);
    }
</style>
{% endblock %}

{% block content %}
<div class="glass-card p-6 mb-6 slide-up">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-2xl font-bold text-white">üó∫Ô∏è X…ôrc X…ôrit…ôsi</h2>
            <p class="text-white/70 text-sm">X…ôrcl…ôrinizin GPS koordinatlarƒ±</p>
        </div>
        <div class="text-right">
            <p class="text-sm text-white/60">√úmumi n√∂qt…ô</p>
            <p class="text-2xl font-bold text-white">{{ points|length }}</p>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Legend -->
    <div class="mt-4 flex items-center gap-4 text-sm text-white/70">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
            <span>X…ôrc n√∂qt…ôsi</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-white/50">|</span>
            <span>{{ points|length }} merchant</span>
        </div>
    </div>
</div>

<!-- Stats Card -->
<div class="glass-card p-6 slide-up" style="animation-delay: 0.1s">
    <h3 class="text-lg font-bold text-white mb-4">üìä X…ôrc Statistikasƒ±</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% set total_amount = points|sum(attribute='amount') %}
        {% set categories = points|map(attribute='category')|unique|list %}

        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">√úmumi</p>
            <p class="text-2xl font-bold text-white">{{ "%.0f"|format(total_amount) }} ‚Çº</p>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">N√∂qt…ôl…ôr</p>
            <p class="text-2xl font-bold text-white">{{ points|length }}</p>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">Kateqoriya</p>
            <p class="text-2xl font-bold text-white">{{ categories|length }}</p>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">Ortalama</p>
            <p class="text-2xl font-bold text-white">{{ "%.0f"|format(total_amount / points|length if points|length > 0
                else 0) }} ‚Çº</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const mapPoints = {{ points | tojson | safe }};

    // Initialize map centered on Baku
    const map = L.map('map').setView([40.4093, 49.8671], 12);

    // Light tile layer for a clean white map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);

    // Add markers for each expense
    mapPoints.forEach((point, index) => {
        // Create custom red marker icon
        const redIcon = L.divIcon({
            className: 'merchant-marker',
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        // Add marker
        const marker = L.marker([point.lat, point.lon], { icon: redIcon }).addTo(map);

        // Create merchant label (always visible)
        const label = L.marker([point.lat, point.lon], {
            icon: L.divIcon({
                className: 'merchant-label',
                html: `<div style="font-size: 11px; font-weight: 600;">${point.merchant}</div>`,
                iconSize: null,
                iconAnchor: [0, -15]
            }),
            interactive: false
        }).addTo(map);

        // Add popup with details
        marker.bindPopup(`
            <div style="min-width: 150px;">
                <p style="font-weight: 700; font-size: 14px; margin-bottom: 6px;">${point.merchant}</p>
                <p style="font-size: 12px; opacity: 0.8; margin-bottom: 4px;">${point.category}</p>
                <p style="font-size: 16px; font-weight: 700; color: #ef4444; margin-bottom: 6px;">${point.amount.toFixed(2)} AZN</p>
                <p style="font-size: 10px; opacity: 0.6; font-family: monospace;">
                    üìç ${point.lat.toFixed(4)}, ${point.lon.toFixed(4)}
                </p>
            </div>
        `);
    });

    // Fit map to show all markers
    if (mapPoints.length > 0) {
        const bounds = L.latLngBounds(mapPoints.map(p => [p.lat, p.lon]));
        map.fitBounds(bounds, { padding: [50, 50] });
    }
</script>
{% endblock %}
