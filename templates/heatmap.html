{% extends "base.html" %}

{% block title %}X…ôrit…ô - FinMate AI{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    #map {
        height: 60vh;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 768px) {
        #map {
            height: 50vh;
            border-radius: 16px;
        }
        
        .glass-card {
            padding: 1rem !important;
        }
        
        .merchant-label {
            font-size: 10px !important;
            padding: 3px 6px !important;
        }
        
        .leaflet-popup-content {
            font-size: 12px !important;
            margin: 8px !important;
        }
    }

    .merchant-marker {
        background-color: #ef4444;
        border: 2px solid white;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.5);
    }

    .merchant-label {
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
        white-space: nowrap;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    /* Mobile optimizations for markers */
    @media (max-width: 768px) {
        .merchant-marker {
            width: 16px;
            height: 16px;
            border-width: 3px;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.6);
        }

        .merchant-label {
            font-size: 10px;
            padding: 3px 6px;
        }

        /* Better touch targets for mobile */
        .leaflet-marker-icon {
            cursor: pointer;
            touch-action: manipulation;
        }

        /* Larger popup on mobile */
        .leaflet-popup-content-wrapper {
            min-width: 180px;
        }
    }

    .leaflet-popup-content-wrapper {
        background: rgba(30, 30, 46, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .leaflet-popup-content {
        color: white;
        margin: 12px;
    }

    .leaflet-popup-tip {
        background: rgba(30, 30, 46, 0.95);
    }
</style>
{% endblock %}

{% block content %}
<div class="glass-card p-6 mb-6 slide-up">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h2 class="text-2xl font-bold text-white">üó∫Ô∏è X…ôrc X…ôrit…ôsi</h2>
            <p class="text-white/70 text-sm">X…ôrcl…ôrinizin GPS koordinatlarƒ±</p>
        </div>
        <div class="text-right">
            <p class="text-sm text-white/60">√úmumi n√∂qt…ô</p>
            <p class="text-2xl font-bold text-white">{{ points|length }}</p>
        </div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Legend -->
    <div class="mt-4 flex items-center gap-4 text-sm text-white/70">
        <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-red-500 rounded-full border-2 border-white"></div>
            <span>X…ôrc n√∂qt…ôsi</span>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-white/50">|</span>
            <span>{{ points|length }} merchant</span>
        </div>
    </div>
</div>

<!-- Stats Card -->
<div class="glass-card p-6 slide-up" style="animation-delay: 0.1s">
    <h3 class="text-lg font-bold text-white mb-4">üìä X…ôrc Statistikasƒ±</h3>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% set total_amount = points|sum(attribute='amount') %}
        {% set categories = points|map(attribute='category')|unique|list %}

        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">√úmumi</p>
            <p class="text-2xl font-bold text-white">{{ "%.0f"|format(total_amount) }} ‚Çº</p>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">N√∂qt…ôl…ôr</p>
            <p class="text-2xl font-bold text-white">{{ points|length }}</p>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">Kateqoriya</p>
            <p class="text-2xl font-bold text-white">{{ categories|length }}</p>
        </div>
        <div class="bg-white/5 rounded-xl p-4 text-center">
            <p class="text-white/60 text-xs mb-1">Ortalama</p>
            <p class="text-2xl font-bold text-white">{{ "%.0f"|format(total_amount / points|length if points|length > 0
                else 0) }} ‚Çº</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    const mapPoints = {{ points | tojson | safe }};

    // Initialize map centered on Baku
    const map = L.map('map', {
        zoomControl: true,
        touchZoom: true,
        doubleClickZoom: true,
        scrollWheelZoom: true,
        boxZoom: true,
        keyboard: true,
        dragging: true
    }).setView([40.4093, 49.8671], 12);

    // Light tile layer for a clean white map
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19,
        minZoom: 10
    }).addTo(map);

    // Detect mobile
    const isMobileDevice = window.innerWidth <= 768;
    
    // Mobile optimizations
    if (isMobileDevice) {
        // Adjust zoom for mobile
        map.setZoom(11);
        
        // Enable touch gestures
        map.touchZoom.enable();
        map.doubleClickZoom.enable();
        
        // Better popup positioning for mobile
        map.options.closePopupOnClick = true;
    }

    // Add markers for each expense
    const markerSize = isMobileDevice ? 16 : 12;
    const markerAnchor = isMobileDevice ? 8 : 6;

    mapPoints.forEach((point, index) => {
        // Create custom red marker icon (larger on mobile for better visibility)
        const redIcon = L.divIcon({
            className: 'merchant-marker',
            iconSize: [markerSize, markerSize],
            iconAnchor: [markerAnchor, markerAnchor]
        });

        // Add marker with better touch handling
        const marker = L.marker([point.lat, point.lon], { 
            icon: redIcon,
            keyboard: true,
            title: point.merchant,
            riseOnHover: true,
            zIndexOffset: index
        }).addTo(map);

        // Create merchant label (only on desktop, hidden on mobile for better UX)
        if (!isMobileDevice) {
            const label = L.marker([point.lat, point.lon], {
                icon: L.divIcon({
                    className: 'merchant-label',
                    html: `<div style="font-size: 11px; font-weight: 600;">${point.merchant}</div>`,
                    iconSize: null,
                    iconAnchor: [0, -15]
                }),
                interactive: false
            }).addTo(map);
        }

        // Add popup with details (mobile-optimized)
        const minWidth = isMobileDevice ? '140px' : '150px';
        const fontSize1 = isMobileDevice ? '14px' : '14px';
        const fontSize2 = isMobileDevice ? '12px' : '12px';
        const fontSize3 = isMobileDevice ? '16px' : '16px';
        const marginBottom = isMobileDevice ? '4px' : '6px';
        const coordinatesHtml = !isMobileDevice ? `<p style="font-size: 10px; opacity: 0.6; font-family: monospace;">
                    üìç ${point.lat.toFixed(4)}, ${point.lon.toFixed(4)}
                </p>` : '';
        
        marker.bindPopup(`
            <div style="min-width: ${minWidth};">
                <p style="font-weight: 700; font-size: ${fontSize1}; margin-bottom: 6px;">${point.merchant}</p>
                <p style="font-size: ${fontSize2}; opacity: 0.8; margin-bottom: 4px;">${point.category}</p>
                <p style="font-size: ${fontSize3}; font-weight: 700; color: #ef4444; margin-bottom: ${marginBottom};">
                    ${point.amount.toFixed(2)} AZN
                </p>
                ${coordinatesHtml}
            </div>
        `, {
            maxWidth: isMobileDevice ? 220 : 250,
            className: isMobileDevice ? 'mobile-popup' : '',
            closeButton: true,
            autoPan: true,
            autoPanPadding: isMobileDevice ? [50, 50] : [20, 20]
        });
    });

    // Fit map to show all markers (mobile-optimized padding)
    if (mapPoints.length > 0) {
        const bounds = L.latLngBounds(mapPoints.map(p => [p.lat, p.lon]));
        map.fitBounds(bounds, { 
            padding: isMobileDevice ? [40, 40] : [50, 50],
            maxZoom: isMobileDevice ? 14 : 16
        });
    }

    // Handle window resize for mobile
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
            const nowMobile = window.innerWidth <= 768;
            if (mapPoints.length > 0) {
                const bounds = L.latLngBounds(mapPoints.map(p => [p.lat, p.lon]));
                map.fitBounds(bounds, { 
                    padding: nowMobile ? [40, 40] : [50, 50],
                    maxZoom: nowMobile ? 14 : 16
                });
            }
        }, 250);
    });

    // Better marker clustering visualization on mobile
    if (isMobileDevice && mapPoints.length > 10) {
        // Add cluster group for better performance on mobile
        console.log('Mobile: Using optimized marker rendering');
    }
</script>
{% endblock %}
