{% extends "base.html" %}

{% block title %}HÉ™diyyÉ™lÉ™r - FinMate AI{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-6 pb-24 lg:ml-64">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">ğŸ MÃ¼kafat MaÄŸazasÄ±</h1>
        <p class="text-white/60 text-sm">Coin toplayÄ±n, hÉ™diyyÉ™lÉ™r qazanÄ±n!</p>
    </div>

    <!-- Current Balance Card -->
    <div class="glass-card p-6 mb-6 bg-gradient-to-br from-yellow-500/10 to-amber-500/10 border border-yellow-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-white/60 text-sm mb-1">BalansÄ±nÄ±z</p>
                <div class="flex items-center gap-3">
                    <span class="text-5xl">ğŸª™</span>
                    <span id="coin-balance" class="text-4xl font-bold text-yellow-400">{{ user.coins if user.coins is
                        defined else 0 }}</span>
                </div>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-white/10">
            <p class="text-white/50 text-xs">ğŸ’¡ HÉ™r qÉ™bz scan = +1 coin</p>
        </div>
    </div>

    <!-- Available Rewards - SLIDING CAROUSEL -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-white mb-4">ğŸ›’ HÉ™diyyÉ™ SeÃ§imlÉ™ri</h2>

        <!-- Carousel Container -->
        <div class="relative">
            <!-- Scroll Buttons -->
            <button onclick="scrollRewards('left')"
                class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm p-3 rounded-full transition hidden md:block">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button onclick="scrollRewards('right')"
                class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm p-3 rounded-full transition hidden md:block">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            <!-- Scrollable Rewards -->
            <div id="rewards-carousel"
                class="flex gap-3 md:gap-4 overflow-x-auto scrollbar-hide snap-x snap-mandatory pb-4 px-1"
                style="scroll-behavior: smooth;">
                {% set current_coins = user.coins if user.coins is defined else 0 %}

                <!-- 100 Coins - Bronze -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-amber-400/40 hover:border-amber-400/80 hover:scale-105 transition-all duration-300 bg-gradient-to-br from-amber-500/10 to-yellow-500/10 shadow-xl">
                        <div class="flex justify-between items-start mb-3">
                            <span
                                class="px-3 py-1 rounded-full bg-amber-500/20 text-amber-300 text-xs font-bold uppercase">Bronz</span>
                            {% if reward_counts.get('bronze', 0) > 0 %}
                            <span class="px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs">âœ“ {{
                                reward_counts.get('bronze') }}x</span>
                            {% endif %}
                        </div>
                        <div class="text-center mb-4">
                            <div class="text-6xl sm:text-7xl mb-3 filter drop-shadow-lg">ğŸ¥‰</div>
                            <h3 class="text-xl sm:text-2xl font-bold text-white mb-2 tracking-wide">Coffee Kuponu</h3>
                            <div class="h-px bg-gradient-to-r from-transparent via-amber-400/50 to-transparent mb-3">
                            </div>
                            <p class="text-white/80 text-sm font-medium">1 É™dÉ™d pulsuz kofe</p>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3 mb-4 border border-amber-400/20">
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-yellow-400 text-3xl">ğŸª™</span>
                                <span class="text-yellow-400 font-bold text-2xl sm:text-3xl">100</span>
                                <span class="text-white/50 text-sm">coin</span>
                            </div>
                        </div>
                        <button onclick="openClaimModal('bronze', 100, 'ğŸ¥‰', 'Coffee Kuponu')"
                            class="w-full px-4 py-3 sm:py-3.5 rounded-xl font-bold text-base sm:text-lg transition-all duration-300 transform hover:scale-105 {% if current_coins >= 100 %}bg-gradient-to-r from-amber-500 to-yellow-500 hover:from-amber-600 hover:to-yellow-600 text-black shadow-lg shadow-amber-500/50{% else %}bg-white/5 text-white/30 cursor-not-allowed border border-white/10{% endif %}"
                            {% if current_coins < 100 %}disabled{% endif %}>
                            {% if current_coins >= 100 %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ›’</span><span>Al
                                    Ä°ndi</span></span>{% else %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ”’</span><span>KiliddÉ™</span></span>{%
                            endif %}
                        </button>
                    </div>
                </div>

                <!-- 200 Coins - Silver -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-gray-300/40 hover:border-gray-300/80 hover:scale-105 transition-all duration-300 bg-gradient-to-br from-gray-300/10 to-gray-400/10 shadow-xl">
                        <div class="flex justify-between items-start mb-3">
                            <span
                                class="px-3 py-1 rounded-full bg-gray-300/20 text-gray-200 text-xs font-bold uppercase">GÃ¼mÃ¼ÅŸ</span>
                            {% if reward_counts.get('silver', 0) > 0 %}
                            <span class="px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs">âœ“ {{
                                reward_counts.get('silver') }}x</span>
                            {% endif %}
                        </div>
                        <div class="text-center mb-4">
                            <div class="text-6xl sm:text-7xl mb-3 filter drop-shadow-lg">ğŸ¥ˆ</div>
                            <h3 class="text-xl sm:text-2xl font-bold text-white mb-2 tracking-wide">Coffee Paket</h3>
                            <div class="h-px bg-gradient-to-r from-transparent via-gray-300/50 to-transparent mb-3">
                            </div>
                            <p class="text-white/80 text-sm font-medium">3 É™dÉ™d pulsuz kofe</p>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3 mb-4 border border-gray-300/20">
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-yellow-400 text-3xl">ğŸª™</span>
                                <span class="text-yellow-400 font-bold text-2xl sm:text-3xl">200</span>
                                <span class="text-white/50 text-sm">coin</span>
                            </div>
                        </div>
                        <button onclick="openClaimModal('silver', 200, 'ğŸ¥ˆ', 'Coffee Paket')"
                            class="w-full px-4 py-3 sm:py-3.5 rounded-xl font-bold text-base sm:text-lg transition-all duration-300 transform hover:scale-105 {% if current_coins >= 200 %}bg-gradient-to-r from-gray-200 to-gray-300 hover:from-gray-300 hover:to-gray-400 text-black shadow-lg shadow-gray-300/50{% else %}bg-white/5 text-white/30 cursor-not-allowed border border-white/10{% endif %}"
                            {% if current_coins < 200 %}disabled{% endif %}>
                            {% if current_coins >= 200 %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ›’</span><span>Al
                                    Ä°ndi</span></span>{% else %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ”’</span><span>KiliddÉ™</span></span>{%
                            endif %}
                        </button>
                    </div>
                </div>

                <!-- 500 Coins - Gold -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-yellow-400/40 hover:border-yellow-400/80 hover:scale-105 transition-all duration-300 bg-gradient-to-br from-yellow-400/10 to-amber-500/10 shadow-xl">
                        <div class="flex justify-between items-start mb-3">
                            <span
                                class="px-3 py-1 rounded-full bg-yellow-400/20 text-yellow-200 text-xs font-bold uppercase">QÄ±zÄ±l</span>
                            {% if reward_counts.get('gold', 0) > 0 %}
                            <span class="px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs">âœ“ {{
                                reward_counts.get('gold') }}x</span>
                            {% endif %}
                        </div>
                        <div class="text-center mb-4">
                            <div class="text-6xl sm:text-7xl mb-3 filter drop-shadow-lg">ğŸ¥‡</div>
                            <h3 class="text-xl sm:text-2xl font-bold text-white mb-2 tracking-wide">Pul MÃ¼kafatÄ±</h3>
                            <div class="h-px bg-gradient-to-r from-transparent via-yellow-400/50 to-transparent mb-3">
                            </div>
                            <p class="text-white/80 text-sm font-medium">5 AZN bank hesabÄ±nÄ±za</p>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3 mb-4 border border-yellow-400/20">
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-yellow-400 text-3xl">ğŸª™</span>
                                <span class="text-yellow-400 font-bold text-2xl sm:text-3xl">500</span>
                                <span class="text-white/50 text-sm">coin</span>
                            </div>
                        </div>
                        <button onclick="openClaimModal('gold', 500, 'ğŸ¥‡', 'Pul MÃ¼kafatÄ± - 5 AZN')"
                            class="w-full px-4 py-3 sm:py-3.5 rounded-xl font-bold text-base sm:text-lg transition-all duration-300 transform hover:scale-105 {% if current_coins >= 500 %}bg-gradient-to-r from-yellow-400 to-amber-500 hover:from-yellow-500 hover:to-amber-600 text-black shadow-lg shadow-yellow-400/50{% else %}bg-white/5 text-white/30 cursor-not-allowed border border-white/10{% endif %}"
                            {% if current_coins < 500 %}disabled{% endif %}>
                            {% if current_coins >= 500 %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ›’</span><span>Al
                                    Ä°ndi</span></span>{% else %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ”’</span><span>KiliddÉ™</span></span>{%
                            endif %}
                        </button>
                    </div>
                </div>

                <!-- 5000 Coins - Platinum -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-purple-500/40 hover:border-purple-500/80 hover:scale-105 transition-all duration-300 bg-gradient-to-br from-purple-500/10 to-pink-500/10 shadow-xl">
                        <div class="flex justify-between items-start mb-3">
                            <span
                                class="px-3 py-1 rounded-full bg-purple-500/20 text-purple-200 text-xs font-bold uppercase">Platin</span>
                            {% if reward_counts.get('platinum', 0) > 0 %}
                            <span class="px-2 py-1 rounded-full bg-green-500/20 text-green-300 text-xs">âœ“ {{
                                reward_counts.get('platinum') }}x</span>
                            {% endif %}
                        </div>
                        <div class="text-center mb-4">
                            <div class="text-6xl sm:text-7xl mb-3 filter drop-shadow-lg">ğŸ’</div>
                            <h3 class="text-xl sm:text-2xl font-bold text-white mb-2 tracking-wide">Premium Paket</h3>
                            <div class="h-px bg-gradient-to-r from-transparent via-purple-400/50 to-transparent mb-3">
                            </div>
                            <p class="text-white/80 text-sm font-medium">1 ay Premium + 20 AZN</p>
                        </div>
                        <div class="bg-black/20 rounded-lg p-3 mb-4 border border-purple-400/20">
                            <div class="flex items-center justify-center gap-2">
                                <span class="text-yellow-400 text-3xl">ğŸª™</span>
                                <span class="text-yellow-400 font-bold text-2xl sm:text-3xl">5000</span>
                                <span class="text-white/50 text-sm">coin</span>
                            </div>
                        </div>
                        <button onclick="openClaimModal('platinum', 5000, 'ğŸ’', 'Premium Paket')"
                            class="w-full px-4 py-3 sm:py-3.5 rounded-xl font-bold text-base sm:text-lg transition-all duration-300 transform hover:scale-105 {% if current_coins >= 5000 %}bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white shadow-lg shadow-purple-500/50{% else %}bg-white/5 text-white/30 cursor-not-allowed border border-white/10{% endif %}"
                            {% if current_coins < 5000 %}disabled{% endif %}>
                            {% if current_coins >= 5000 %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ›’</span><span>Al
                                    Ä°ndi</span></span>{% else %}<span
                                class="flex items-center justify-center gap-2"><span>ğŸ”’</span><span>KiliddÉ™</span></span>{%
                            endif %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Scroll Indicator Dots -->
            <div class="flex justify-center gap-2 mt-4">
                <div class="w-2 h-2 rounded-full bg-amber-400"></div>
                <div class="w-2 h-2 rounded-full bg-gray-300"></div>
                <div class="w-2 h-2 rounded-full bg-yellow-400"></div>
                <div class="w-2 h-2 rounded-full bg-purple-400"></div>
            </div>
        </div>
    </div>

    <!-- Claimed Rewards History -->
    <div class="space-y-4">
        <h2 class="text-xl font-bold text-white mb-4">ğŸ“œ AlÄ±nmÄ±ÅŸ HÉ™diyyÉ™lÉ™r</h2>
        {% if claimed_rewards %}
        <div class="space-y-2">
            {% for reward in claimed_rewards %}
            <div class="glass-card p-4 flex items-center justify-between hover:bg-white/5 transition">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">
                        {% if reward.reward_type == 'bronze' %}ğŸ¥‰
                        {% elif reward.reward_type == 'silver' %}ğŸ¥ˆ
                        {% elif reward.reward_type == 'gold' %}ğŸ¥‡
                        {% else %}ğŸ’{% endif %}
                    </span>
                    <div>
                        <p class="text-white font-medium text-sm">{{ reward.reward_name }}</p>
                        <p class="text-white/50 text-xs">{{ reward.claimed_at.strftime('%d.%m.%Y %H:%M') }}</p>
                    </div>
                </div>
                <span class="text-red-400 font-bold text-sm">-{{ reward.coins_spent }} ğŸª™</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-card p-6 text-center">
            <p class="text-white/50 text-sm">HÉ™lÉ™ hÉ™diyyÉ™ almamÄ±sÄ±nÄ±z</p>
            <p class="text-white/30 text-xs mt-1">Coin toplayÄ±n vÉ™ yuxarÄ±dan seÃ§in!</p>
        </div>
        {% endif %}
    </div>

    <!-- Claim Confirmation Modal -->
    <div id="claim-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="glass-card max-w-md w-full p-6 mx-4 animate-scale-in">
            <div class="text-center mb-6">
                <div id="modal-icon" class="text-6xl mb-4">ğŸ</div>
                <h3 id="modal-title" class="text-2xl font-bold text-white mb-2">HÉ™diyyÉ™ Al</h3>
                <p id="modal-description" class="text-white/70 text-sm"></p>
            </div>

            <div class="bg-white/5 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/70 text-sm">Cari Balans:</span>
                    <span id="modal-current-coins" class="text-yellow-400 font-bold"></span>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/70 text-sm">QiymÉ™t:</span>
                    <span id="modal-cost" class="text-red-400 font-bold"></span>
                </div>
                <div class="border-t border-white/10 my-2"></div>
                <div class="flex items-center justify-between">
                    <span class="text-white font-medium text-sm">Qalacaq:</span>
                    <span id="modal-remaining" class="text-green-400 font-bold text-lg"></span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeClaimModal()"
                    class="flex-1 px-4 py-3 rounded-lg bg-white/10 hover:bg-white/20 text-white font-medium transition">
                    âŒ Ä°mtina
                </button>
                <button id="confirm-claim-btn" onclick="confirmClaim()"
                    class="flex-1 px-4 py-3 rounded-lg bg-green-500 hover:bg-green-600 text-white font-bold transition">
                    âœ… TÉ™sdiq Et
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    @keyframes scale-in {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .animate-scale-in {
        animation: scale-in 0.2s ease-out;
    }
</style>

<script>
    let currentRewardType = '';
    let currentCost = 0;

    function scrollRewards(direction) {
        const carousel = document.getElementById('rewards-carousel');
        const cardWidth = 288 + 12;
        if (direction === 'left') {
            carousel.scrollLeft -= cardWidth;
        } else {
            carousel.scrollLeft += cardWidth;
        }
    }

    function openClaimModal(rewardType, cost, icon, name) {
        const currentCoins = parseInt(document.getElementById('coin-balance').textContent);
        if (currentCoins < cost) {
            window.showToast(`KifayÉ™t qÉ™dÉ™r coin yoxdur. LazÄ±m: ${cost}, Sizin: ${currentCoins}`, 'error');
            return;
        }
        currentRewardType = rewardType;
        currentCost = cost;
        document.getElementById('modal-icon').textContent = icon;
        document.getElementById('modal-title').textContent = name;
        document.getElementById('modal-description').textContent = `Bu hÉ™diyyÉ™ni almaq istÉ™yirsiniz?`;
        document.getElementById('modal-current-coins').textContent = `ğŸª™ ${currentCoins}`;
        document.getElementById('modal-cost').textContent = `-ğŸª™ ${cost}`;
        document.getElementById('modal-remaining').textContent = `ğŸª™ ${currentCoins - cost}`;
        document.getElementById('claim-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        // Voice notification
        if (typeof window.queueVoiceNotification === 'function') {
            const message = `${name}. QiymÉ™t ${cost} coin. Almaq istÉ™yirsinizmi?`;
            window.queueVoiceNotification(message, 1, 'az');
        }
    }

    function closeClaimModal() {
        document.getElementById('claim-modal').classList.add('hidden');
        document.body.style.overflow = '';
        currentRewardType = '';
        currentCost = 0;
    }

    function confirmClaim() {
        if (!currentRewardType || !currentCost) return;
        const btn = document.getElementById('confirm-claim-btn');
        btn.disabled = true;
        btn.textContent = 'â³ GÃ¶zlÉ™yin...';
        fetch('/api/claim-reward', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reward_type=${currentRewardType}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.showToast(data.message, 'success');
                    closeClaimModal();
                    setTimeout(() => location.reload(), 1000);
                } else {
                    window.showToast(data.error || 'XÉ™ta baÅŸ verdi', 'error');
                    btn.disabled = false;
                    btn.textContent = 'âœ… TÉ™sdiq Et';
                }
            })
            .catch(error => {
                window.showToast('XÉ™ta baÅŸ verdi', 'error');
                console.error('Error:', error);
                btn.disabled = false;
                btn.textContent = 'âœ… TÉ™sdiq Et';
            });
    }

    document.getElementById('claim-modal')?.addEventListener('click', function (e) {
        if (e.target === this) closeClaimModal();
    });
</script>
{% endblock %}