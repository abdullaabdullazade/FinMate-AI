{% extends "base.html" %}

{% block title %}HÉ™diyyÉ™lÉ™r - FinMate AI{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto px-4 py-6 pb-24 lg:ml-64">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-2xl sm:text-3xl font-bold text-white mb-2">ğŸ HÉ™diyyÉ™lÉ™r</h1>
        <p class="text-white/60 text-sm">Coin xÉ™rclÉ™yib hÉ™diyyÉ™ al!</p>
    </div>

    <!-- Current Balance Card -->
    <div class="glass-card p-6 mb-6 bg-gradient-to-br from-yellow-500/10 to-amber-500/10 border border-yellow-500/20">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-white/60 text-sm mb-1">BalansÄ±nÄ±z</p>
                <div class="flex items-center gap-3">
                    <span class="text-5xl">ğŸª™</span>
                    <span id="coin-balance" class="text-4xl font-bold text-yellow-400">{{ user.coins if user.coins is
                        defined else 0 }}</span>
                </div>
            </div>
        </div>
        <div class="mt-4 pt-4 border-t border-white/10">
            <p class="text-white/50 text-xs">ğŸ’¡ HÉ™r qÉ™bz scan = +1 coin</p>
        </div>
    </div>

    <!-- Available Rewards - SLIDING CAROUSEL -->
    <div class="mb-8">
        <h2 class="text-xl font-bold text-white mb-4">ğŸ›’ MaÄŸaza</h2>

        <!-- Carousel Container -->
        <div class="relative">
            <!-- Scroll Buttons -->
            <button onclick="scrollRewards('left')"
                class="absolute left-0 top-1/2 -translate-y-1/2 z-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm p-3 rounded-full transition hidden md:block">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button onclick="scrollRewards('right')"
                class="absolute right-0 top-1/2 -translate-y-1/2 z-10 bg-white/10 hover:bg-white/20 backdrop-blur-sm p-3 rounded-full transition hidden md:block">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            <!-- Scrollable Rewards -->
            <div id="rewards-carousel"
                class="flex gap-3 md:gap-4 overflow-x-auto scrollbar-hide snap-x snap-mandatory pb-4 px-1"
                style="scroll-behavior: smooth;">
                {% set current_coins = user.coins if user.coins is defined else 0 %}

                <!-- 100 Coins - Bronze -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-amber-400/30 hover:border-amber-400/60 transition bg-gradient-to-br from-amber-500/5 to-yellow-500/5">
                        <div class="text-center mb-3 sm:mb-4">
                            <div class="text-5xl sm:text-6xl mb-2 sm:mb-3 animate-bounce">ğŸ¥‰</div>
                            <h3 class="text-lg sm:text-xl font-bold text-white mb-1 sm:mb-2">Bronz Paket</h3>
                            <p class="text-white/70 text-xs sm:text-sm mb-1">1 Coffee Kuponu</p>
                            {% if reward_counts.get('bronze', 0) > 0 %}
                            <p class="text-green-400 text-xs">âœ… {{ reward_counts.get('bronze') }}x alÄ±nÄ±b</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center justify-center gap-2 mb-3 sm:mb-4">
                            <span class="text-yellow-400 font-bold text-xl sm:text-2xl">ğŸª™ 100</span>
                        </div>
                        <button onclick="openClaimModal('bronze', 100, 'ğŸ¥‰', '1 Coffee Kuponu')"
                            class="w-full px-4 py-2.5 sm:py-3 rounded-lg font-bold text-base sm:text-lg transition {% if current_coins >= 100 %}bg-amber-500 hover:bg-amber-600 text-black shadow-lg shadow-amber-500/50{% else %}bg-white/10 text-white/30 cursor-not-allowed{% endif %}"
                            {% if current_coins < 100 %}disabled{% endif %}>
                            {% if current_coins >= 100 %}ğŸ›’ Al{% else %}ğŸ”’ KiliddÉ™{% endif %}
                        </button>
                    </div>
                </div>

                <!-- 200 Coins - Silver -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-gray-300/30 hover:border-gray-300/60 transition bg-gradient-to-br from-gray-200/5 to-gray-400/5">
                        <div class="text-center mb-3 sm:mb-4">
                            <div class="text-5xl sm:text-6xl mb-2 sm:mb-3 animate-bounce">ğŸ¥ˆ</div>
                            <h3 class="text-lg sm:text-xl font-bold text-white mb-1 sm:mb-2">GÃ¼mÃ¼ÅŸ Paket</h3>
                            <p class="text-white/70 text-xs sm:text-sm mb-1">3 Coffee Kuponu</p>
                            {% if reward_counts.get('silver', 0) > 0 %}
                            <p class="text-green-400 text-xs">âœ… {{ reward_counts.get('silver') }}x alÄ±nÄ±b</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center justify-center gap-2 mb-3 sm:mb-4">
                            <span class="text-yellow-400 font-bold text-xl sm:text-2xl">ğŸª™ 200</span>
                        </div>
                        <button onclick="openClaimModal('silver', 200, 'ğŸ¥ˆ', '3 Coffee Kuponu')"
                            class="w-full px-4 py-2.5 sm:py-3 rounded-lg font-bold text-base sm:text-lg transition {% if current_coins >= 200 %}bg-gray-200 hover:bg-gray-300 text-black shadow-lg shadow-gray-300/50{% else %}bg-white/10 text-white/30 cursor-not-allowed{% endif %}"
                            {% if current_coins < 200 %}disabled{% endif %}>
                            {% if current_coins >= 200 %}ğŸ›’ Al{% else %}ğŸ”’ KiliddÉ™{% endif %}
                        </button>
                    </div>
                </div>

                <!-- 500 Coins - Gold -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-yellow-400/30 hover:border-yellow-400/60 transition bg-gradient-to-br from-yellow-400/5 to-amber-500/5">
                        <div class="text-center mb-3 sm:mb-4">
                            <div class="text-5xl sm:text-6xl mb-2 sm:mb-3 animate-bounce">ğŸ¥‡</div>
                            <h3 class="text-lg sm:text-xl font-bold text-white mb-1 sm:mb-2">QÄ±zÄ±l Paket</h3>
                            <p class="text-white/70 text-xs sm:text-sm mb-1">5 AZN pul mÃ¼kafatÄ±</p>
                            {% if reward_counts.get('gold', 0) > 0 %}
                            <p class="text-green-400 text-xs">âœ… {{ reward_counts.get('gold') }}x alÄ±nÄ±b</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center justify-center gap-2 mb-3 sm:mb-4">
                            <span class="text-yellow-400 font-bold text-xl sm:text-2xl">ğŸª™ 500</span>
                        </div>
                        <button onclick="openClaimModal('gold', 500, 'ğŸ¥‡', '5 AZN pul mÃ¼kafatÄ±')"
                            class="w-full px-4 py-2.5 sm:py-3 rounded-lg font-bold text-base sm:text-lg transition {% if current_coins >= 500 %}bg-yellow-400 hover:bg-yellow-500 text-black shadow-lg shadow-yellow-400/50{% else %}bg-white/10 text-white/30 cursor-not-allowed{% endif %}"
                            {% if current_coins < 500 %}disabled{% endif %}>
                            {% if current_coins >= 500 %}ğŸ›’ Al{% else %}ğŸ”’ KiliddÉ™{% endif %}
                        </button>
                    </div>
                </div>

                <!-- 5000 Coins - Platinum -->
                <div class="flex-shrink-0 w-72 sm:w-80 snap-center">
                    <div
                        class="glass-card p-5 sm:p-6 h-full border-2 border-purple-500/30 hover:border-purple-500/60 transition bg-gradient-to-br from-purple-500/5 to-pink-500/5">
                        <div class="text-center mb-3 sm:mb-4">
                            <div class="text-5xl sm:text-6xl mb-2 sm:mb-3 animate-bounce">ğŸ’</div>
                            <h3 class="text-lg sm:text-xl font-bold text-white mb-1 sm:mb-2">Platin Paket</h3>
                            <p class="text-white/70 text-xs sm:text-sm mb-1">Premium 1 ay + 20 AZN</p>
                            {% if reward_counts.get('platinum', 0) > 0 %}
                            <p class="text-green-400 text-xs">âœ… {{ reward_counts.get('platinum') }}x alÄ±nÄ±b</p>
                            {% endif %}
                        </div>
                        <div class="flex items-center justify-center gap-2 mb-3 sm:mb-4">
                            <span class="text-yellow-400 font-bold text-xl sm:text-2xl">ğŸª™ 5000</span>
                        </div>
                        <button onclick="openClaimModal('platinum', 5000, 'ğŸ’', 'Premium 1 ay + 20 AZN')"
                            class="w-full px-4 py-2.5 sm:py-3 rounded-lg font-bold text-base sm:text-lg transition {% if current_coins >= 5000 %}bg-purple-500 hover:bg-purple-600 text-white shadow-lg shadow-purple-500/50{% else %}bg-white/10 text-white/30 cursor-not-allowed{% endif %}"
                            {% if current_coins < 5000 %}disabled{% endif %}>
                            {% if current_coins >= 5000 %}ğŸ›’ Al{% else %}ğŸ”’ KiliddÉ™{% endif %}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Scroll Indicator Dots -->
            <div class="flex justify-center gap-2 mt-4">
                <div class="scroll-dot w-2 h-2 rounded-full bg-white/30"></div>
                <div class="scroll-dot w-2 h-2 rounded-full bg-white/30"></div>
                <div class="scroll-dot w-2 h-2 rounded-full bg-white/30"></div>
                <div class="scroll-dot w-2 h-2 rounded-full bg-white/30"></div>
            </div>
        </div>
    </div>

    <!-- Claimed Rewards History -->
    <div class="space-y-4">
        <h2 class="text-xl font-bold text-white mb-4">ğŸ“œ AlÄ±nmÄ±ÅŸ HÉ™diyyÉ™lÉ™r</h2>
        {% if claimed_rewards %}
        <div class="space-y-2">
            {% for reward in claimed_rewards %}
            <div class="glass-card p-4 flex items-center justify-between hover:bg-white/5 transition">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">
                        {% if reward.reward_type == 'bronze' %}ğŸ¥‰
                        {% elif reward.reward_type == 'silver' %}ğŸ¥ˆ
                        {% elif reward.reward_type == 'gold' %}ğŸ¥‡
                        {% else %}ğŸ’{% endif %}
                    </span>
                    <div>
                        <p class="text-white font-medium text-sm">{{ reward.reward_name }}</p>
                        <p class="text-white/50 text-xs">{{ reward.claimed_at.strftime('%d.%m.%Y %H:%M') }}</p>
                    </div>
                </div>
                <span class="text-red-400 font-bold text-sm">-{{ reward.coins_spent }} ğŸª™</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-card p-6 text-center">
            <p class="text-white/50 text-sm">HÉ™lÉ™ hÉ™diyyÉ™ almamÄ±sÄ±nÄ±z</p>
            <p class="text-white/30 text-xs mt-1">Coin toplayÄ±n vÉ™ yuxarÄ±dan seÃ§in!</p>
        </div>
        {% endif %}
    </div>

    <!-- Claim Confirmation Modal -->
    <div id="claim-modal"
        class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="glass-card max-w-md w-full p-6 mx-4 animate-scale-in">
            <div class="text-center mb-6">
                <div id="modal-icon" class="text-6xl mb-4">ğŸ</div>
                <h3 id="modal-title" class="text-2xl font-bold text-white mb-2">HÉ™diyyÉ™ Al</h3>
                <p id="modal-description" class="text-white/70 text-sm"></p>
            </div>

            <div class="bg-white/5 rounded-lg p-4 mb-6">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/70 text-sm">Cari Balans:</span>
                    <span id="modal-current-coins" class="text-yellow-400 font-bold"></span>
                </div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-white/70 text-sm">QiymÉ™t:</span>
                    <span id="modal-cost" class="text-red-400 font-bold"></span>
                </div>
                <div class="border-t border-white/10 my-2"></div>
                <div class="flex items-center justify-between">
                    <span class="text-white font-medium text-sm">Qalacaq:</span>
                    <span id="modal-remaining" class="text-green-400 font-bold text-lg"></span>
                </div>
            </div>

            <div class="flex gap-3">
                <button onclick="closeClaimModal()"
                    class="flex-1 px-4 py-3 rounded-lg bg-white/10 hover:bg-white/20 text-white font-medium transition">
                    âŒ Ä°mtina
                </button>
                <button id="confirm-claim-btn" onclick="confirmClaim()"
                    class="flex-1 px-4 py-3 rounded-lg bg-green-500 hover:bg-green-600 text-white font-bold transition">
                    âœ… TÉ™sdiq Et
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Hide scrollbar but keep functionality */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Modal animation */
    @keyframes scale-in {
        from {
            transform: scale(0.9);
            opacity: 0;
        }

        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .animate-scale-in {
        animation: scale-in 0.2s ease-out;
    }
</style>

<script>
    let currentRewardType = '';
    let currentCost = 0;

    function scrollRewards(direction) {
        const carousel = document.getElementById('rewards-carousel');
        const cardWidth = 288 + 12; // 72*4 (w-72) + gap

        if (direction === 'left') {
            carousel.scrollLeft -= cardWidth;
        } else {
            carousel.scrollLeft += cardWidth;
        }
    }

    function openClaimModal(rewardType, cost, icon, name) {
        const currentCoins = parseInt(document.getElementById('coin-balance').textContent);

        if (currentCoins < cost) {
            window.showToast(`KifayÉ™t qÉ™dÉ™r coin yoxdur. LazÄ±m: ${cost}, Sizin: ${currentCoins}`, 'error');
            return;
        }

        currentRewardType = rewardType;
        currentCost = cost;

        document.getElementById('modal-icon').textContent = icon;
        document.getElementById('modal-title').textContent = name;
        document.getElementById('modal-description').textContent = `Bu hÉ™diyyÉ™ni almaq istÉ™yirsiniz?`;
        document.getElementById('modal-current-coins').textContent = `ğŸª™ ${currentCoins}`;
        document.getElementById('modal-cost').textContent = `-ğŸª™ ${cost}`;
        document.getElementById('modal-remaining').textContent = `ğŸª™ ${currentCoins - cost}`;

        document.getElementById('claim-modal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
    }

    function closeClaimModal() {
        document.getElementById('claim-modal').classList.add('hidden');
        document.body.style.overflow = '';
        currentRewardType = '';
        currentCost = 0;
    }

    function confirmClaim() {
        if (!currentRewardType || !currentCost) return;

        const btn = document.getElementById('confirm-claim-btn');
        btn.disabled = true;
        btn.textContent = 'â³ GÃ¶zlÉ™yin...';

        fetch('/api/claim-reward', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `reward_type=${currentRewardType}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.showToast(data.message, 'success');
                    closeClaimModal();
                    // Reload page after short delay
                    setTimeout(() => location.reload(), 1000);
                } else {
                    window.showToast(data.error || 'XÉ™ta baÅŸ verdi', 'error');
                    btn.disabled = false;
                    btn.textContent = 'âœ… TÉ™sdiq Et';
                }
            })
            .catch(error => {
                window.showToast('XÉ™ta baÅŸ verdi', 'error');
                console.error('Error:', error);
                btn.disabled = false;
                btn.textContent = 'âœ… TÉ™sdiq Et';
            });
    }

    // Close modal on outside click
    document.getElementById('claim-modal')?.addEventListener('click', function (e) {
        if (e.target === this) {
            closeClaimModal();
        }
    });
</script>
{% endblock %}