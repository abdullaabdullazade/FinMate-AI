{% extends "base.html" %}

{% block title %}Skan et - FinMate AI{% endblock %}

{% block extra_head %}
<style>
    /* Glassmorphism DizaynÄ± */
    .glass-card {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 1.5rem;
    }

    .slide-up {
        animation: slideUp 0.5s ease-out forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    @keyframes slideUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div id="scanModal" class="fixed inset-0 z-[200] hidden bg-black/90 backdrop-blur-sm flex items-center justify-center">
    <div class="text-center">
        <div class="relative w-24 h-24 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-white/10 rounded-full"></div>
            <div class="absolute inset-0 border-t-4 border-green-500 rounded-full animate-spin"></div>
            <div class="absolute inset-0 flex items-center justify-center text-4xl">ðŸ§¾</div>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">Skan edilir...</h3>
        <p class="text-white/60">SÃ¼ni intellekt Ã§eki emal edir</p>
    </div>
</div>

<div class="max-w-2xl mx-auto pt-2 relative z-10">

    <!-- Initial State: Upload Buttons + Instructions -->
    <div id="initial-state">
        <div class="glass-card p-6 mb-6 text-center slide-up">
            <h2 class="text-2xl font-bold text-white mb-2">ðŸ“¸ Ã‡ek Skan Et</h2>
            <p class="text-white/70 text-sm">Ã‡ekin ÅŸÉ™klini yÃ¼klÉ™yin, AI avtomatik mÉ™lumatlarÄ± Ã§Ä±xarsÄ±n</p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6 slide-up" style="animation-delay: 0.1s">

            <label
                class="group cursor-pointer border-2 border-dashed border-white/30 rounded-2xl p-8 text-center hover:bg-white/5 hover:border-green-500 transition-all duration-300 relative z-20 block bg-black/20">
                <div
                    class="w-14 h-14 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 group-hover:bg-green-500/20 transition-all">
                    <svg class="w-7 h-7 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                </div>
                <p class="text-white font-bold text-lg mb-1">Fayl YÃ¼klÉ™</p>
                <p class="text-white/40 text-xs uppercase tracking-wider">PNG, JPG, PDF</p>
                <input type="file" class="hidden" accept="image/*" onchange="uploadFile(this)">
            </label>

            <label
                class="group cursor-pointer border-2 border-dashed border-white/30 rounded-2xl p-8 text-center hover:bg-white/5 hover:border-purple-500 transition-all duration-300 relative z-20 block bg-black/20">
                <div
                    class="w-14 h-14 bg-purple-500/10 rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 group-hover:bg-purple-500/20 transition-all">
                    <svg class="w-7 h-7 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                </div>
                <p class="text-white font-bold text-lg mb-1">Kamera</p>
                <p class="text-white/40 text-xs uppercase tracking-wider">ÅžÉ™kil Ã‡É™k</p>
                <input type="file" class="hidden" accept="image/*" capture="environment" onchange="uploadFile(this)">
            </label>
        </div>

        <div class="glass-card p-5 mt-6 slide-up" style="animation-delay: 0.3s">
            <h3 class="text-base font-bold text-white mb-3 flex items-center gap-2">
                <span>ðŸ’¡</span> NecÉ™ iÅŸlÉ™yir?
            </h3>
            <ul class="space-y-2 text-white/70 text-sm">
                <li class="flex items-start gap-2">
                    <span class="text-green-400 mt-0.5">âœ“</span>
                    <span>Ã‡ekin ÅŸÉ™klini aydÄ±n Ã§É™kin vÉ™ ya yÃ¼klÉ™yin</span>
                </li>
                <li class="flex items-start gap-2">
                    <span class="text-green-400 mt-0.5">âœ“</span>
                    <span>AI avtomatik olaraq oxuyur</span>
                </li>
            </ul>
        </div>
    </div>

    <!-- Result State -->
    <div id="scanResult" class="slide-up" style="animation-delay: 0.2s"></div>
</div>

<script>
    // Timezone
    function getAzTime() {
        const now = new Date();
        const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
        return new Date(utc + (4 * 3600000)).toISOString();
    }

    // Reset function - brings back upload UI or reload page
    function resetScan() {
        // If receipt was just confirmed, reload page to show updated data
        if (sessionStorage.getItem('reloadAfterReceipt') === 'true') {
            sessionStorage.removeItem('reloadAfterReceipt');
            window.location.reload();
            return;
        }
        
        const initialState = document.getElementById('initial-state');
        const resultDiv = document.getElementById('scanResult');

        // Clear result
        if (resultDiv) resultDiv.innerHTML = '';

        // Show initial state
        if (initialState) initialState.classList.remove('hidden');
    }

    // Upload file function with state toggle
    async function uploadFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const modal = document.getElementById('scanModal');
            const initialState = document.getElementById('initial-state');
            const resultDiv = document.getElementById('scanResult');

            // 1. Show loading modal
            modal.classList.remove('hidden');

            // 2. Prepare data
            const formData = new FormData();
            formData.append('file', file);

            try {
                // 3. Send to server
                const response = await fetch('/api/scan-receipt', {
                    method: 'POST',
                    headers: {
                        'X-Client-Timezone': Intl.DateTimeFormat().resolvedOptions().timeZone,
                        'X-Client-Date': getAzTime()
                    },
                    body: formData
                });

                if (response.ok) {
                    // 4. Success - show result
                    const html = await response.text();
                    resultDiv.innerHTML = html;

                    // Hide initial state (upload buttons)
                    initialState.classList.add('hidden');

                    // Process HTMX if available
                    if (window.htmx) htmx.process(resultDiv);
                } else {
                    console.error('Server Error:', response.status);
                    alert("XÉ™ta: Server cavab vermir.");
                }
            } catch (err) {
                console.error('Network Error:', err);
                alert("Ä°nternet xÉ™tasÄ±.");
            } finally {
                // 5. Clean up
                input.value = '';
                modal.classList.add('hidden');
            }
        }
    }
</script>
{% endblock %}